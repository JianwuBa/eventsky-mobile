{"remainingRequest":"/Users/huodongxingkong/Desktop/eventsky/eventsky-web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/huodongxingkong/Desktop/eventsky/eventsky-web/src/views/live/Live.vue?vue&type=style&index=0&id=773a5025&lang=less&scoped=true&","dependencies":[{"path":"/Users/huodongxingkong/Desktop/eventsky/eventsky-web/src/views/live/Live.vue","mtime":1622622511476},{"path":"/Users/huodongxingkong/Desktop/eventsky/eventsky-web/node_modules/css-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/huodongxingkong/Desktop/eventsky/eventsky-web/node_modules/vue-loader/lib/loaders/stylePostLoader.js","mtime":499162500000},{"path":"/Users/huodongxingkong/Desktop/eventsky/eventsky-web/node_modules/postcss-loader/src/index.js","mtime":499162500000},{"path":"/Users/huodongxingkong/Desktop/eventsky/eventsky-web/node_modules/less-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/huodongxingkong/Desktop/eventsky/eventsky-web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/huodongxingkong/Desktop/eventsky/eventsky-web/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoubGl2ZXsKICAgIHBhZGRpbmc6IDEyMHB4IDAgMTUwcHg7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYmFja2dyb3VuZDogIzBGNUY1NDsKfQoucGxheWVyLWJveHsKICAgIHdpZHRoOiA5MCU7CiAgICBoZWlnaHQ6IDYwMHB4OwogICAgbWFyZ2luOiAwIGF1dG87CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAucGxheWVyLWJ0bnsKICAgICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgIG1hcmdpbjogYXV0bzsKICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgtNTAlLC01MCUsMCk7CiAgICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICAgIHRvcDogNTAlOwogICAgICAgIC52aWRlb3sKICAgICAgICAgICAgd2lkdGg6IDExNXB4OwogICAgICAgICAgICBtYXJnaW46MCBhdXRvIDQwcHg7CiAgICAgICAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgICAgIH0KICAgICAgICAudGV4dHsKICAgICAgICAgICAgYmFja2dyb3VuZDogIzAyN0FGRjsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjOTc5Nzk3OwogICAgICAgICAgICBjb2xvcjogI2ZmZjsKICAgICAgICAgICAgbGluZS1oZWlnaHQ6IDQycHg7CiAgICAgICAgICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgICAgICAgICAgcGFkZGluZzogMCAzMHB4OwogICAgICAgIH0KICAgIH0KICAgIC5lbmRCdG57CiAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOwogICAgICAgIGJvdHRvbTogMThweDsKICAgICAgICBwYWRkaW5nOiAwIDMwcHg7CiAgICAgICAgY29sb3I6ICNmZmY7CiAgICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICAgIGxpbmUtaGVpZ2h0OiA0NHB4OwogICAgICAgIGJhY2tncm91bmQ6ICNGRjU3NTU7CiAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICM5Nzk3OTc7CiAgICB9Cn0K"},{"version":3,"sources":["Live.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA0NA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"Live.vue","sourceRoot":"src/views/live","sourcesContent":["<template>\n    <div>\n        <div ref=\"live\" class=\"live\">\n            <div id=\"local-player\" class=\"player-box\">\n                <div class=\"player-btn\" @click=\"livePrestart\" v-if=\"isLive\">\n                    <img src=\"@/assets/images/video-start.png\" class=\"video\" alt=\"\">\n                    <p class=\"text\">开始直播</p>\n                </div>\n                <div class=\"endBtn\" v-if=\"!isLive\" @click=\"endSkyLive\">直播中，结束直播</div>\n            </div>\n        </div>\n    </div>\n</template>\n\n<script>\nimport {postPrestart,postSkyStartLive,postSkyEndLive} from '@/api/liveService.js'\nimport AgoraRTC from \"agora-rtc-sdk-ng\"\n    export default {\n        data(){\n            return{\n                //直播按钮\n                isLive:true,\n                //屏幕高度\n                clientHeight:'',\n                //活动ID\n                eventId:'',\n                //声网 项目ID\n                appid: \"\",\n                //直播房间\n                channel: \"\", //webId\n                //房间内 用户ID\n                uid: 0,\n                //本次直播  ID\n                lhid: 0,\n                //声网token\n                token: \"\",\n                //角色 （主播和观众）\n                role: \"host\",\n                //声网  直播客户端\n                client :null,\n                //当前 轨道\n                localTracks :{\n                    videoTrack: null,\n                    audioTrack: null\n                },\n                //麦克风\n                mics : [], // all microphones devices you can use\n                //摄像头\n                cams : [], // all cameras devices you can use\n                // 当前麦克风和摄像头\n                currentMic:null, // the microphone you are using\n                currentCam:null, // the camera you are using\n                //直播分辨率\n                videoProfiles : [\n                    { label: \"480p_1\", detail: \"640×480, 15fps, 500Kbps\", value: \"480p_1\" },\n                    { label: \"480p_2\", detail: \"640×480, 30fps, 1000Kbps\", value: \"480p_2\" },\n                    { label: \"720p_1\", detail: \"1280×720, 15fps, 1130Kbps\", value: \"720p_1\" },\n                    { label: \"720p_2\", detail: \"1280×720, 30fps, 2000Kbps\", value: \"720p_2\" },\n                    { label: \"1080p_1\", detail: \"1920×1080, 15fps, 2080Kbps\", value: \"1080p_1\" },\n                    { label: \"1080p_2\", detail: \"1920×1080, 30fps, 3000Kbps\", value: \"1080p_2\" },\n                    { label: \"200×640\", detail: \"200×640, 30fps\", value: { width: 200, height: 640, frameRate: 30 } } // custom video profile\n                ],\n                // 当前分辨率\n                curVideoProfile:null\n            }\n        },\n        methods:{\n            //准备直播\n            async livePrestart(){\n                await postPrestart(this.eventId).then(res => {\n                    console.log(res)\n                    if(res.data.rspCode == 1){\n                        let data = res.data.data\n                        this.appid = data.appId\n                        this.channel = data.channel\n                        this.uid = data.uid\n                        this.lhid = data.historyId\n                        this.token = data.token\n                    }\n                })\n                try {\n                    await this.startLive();\n                    //开始直播\n                    await this.skyStartLive();\n                    //volumeAnimation = requestAnimationFrame(setVolumeWave);\n                    this.isLive = false\n                } \n                catch (error) {\n                    console.error('start live failed!');\n                    console.error(error);\n                    // this.leaveLive();\n                    var errorCode = error.code;\n                    var errMsg = \"开启直播失败,\";\n                    if (errorCode === 'DEVICE_NOT_FOUND') {\n                        errMsg += \"未找到摄像头或麦克风设备!\";\n                    }\n                    errMsg += \"\\n详细错误信息\\n\" + error;\n                    alert(errMsg);\n                } finally {\n                    \n                    //$(\"#btn-stop-live\").attr(\"disabled\", false);\n                    //$(\"#enable-beauty\").attr(\"disabled\", false);\n                    //$(\"#disable-beauty\").attr(\"disabled\", true);\n                }\n            },\n            //声网开始直播\n            async startLive() {\n                // create Agora client\n                this.client.setClientRole(this.role);\n                console.log(this.appid, this.channel, this.token,this.uid)\n                // join the channel\n                this.uid = await this.client.join(this.appid, this.channel, this.token || null, this.uid);\n\n                // create local audio and video tracks\n                this.localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();\n                this.localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack({ encoderConfig: this.curVideoProfile.value });\n                this.localTracks.audioTrack.setVolume(200);\n                const level = this.localTracks.audioTrack.getVolumeLevel();\n                console.log(\"local stream audio level\", level);\n                // play local video track\n                this.localTracks.videoTrack.play(\"local-player\");\n                \n                //$(\"#local-player-name\").text(`localTrack(${options.uid})`);\n                // publish local tracks to channel\n                await this.client.publish([this.localTracks.audioTrack, this.localTracks.videoTrack]);\n                console.log(\"publish success\");\n                // client.on(\"user-left\", handleUserLeft);\n                // client.on(\"connection-state-change\", handleStateChange);\n                // client.on(\"token-privilege-will-expire\", function() {\n                //     console.log(\"onTokenPrivilegeWillExpire\");\n                //     //进行重新申请 Token 操作后\n                //     //client.renewToken(token);\n                // });\n                // client.on(\"token-privilege-did-expire\", function() {\n                //     console.log(\"onTokenPrivilegeDidExpire\");\n                //     $(\"#verification-dialog-3\").modal(\"show\");\n                //     leaveLive();\n                //     //进行重新申请 Token 操作后\n                //     //client.renewToken(token);\n                // });\n                //initStats();\n            },\n            //活动星空开始直播\n            skyStartLive(){\n                postSkyStartLive(this.eventId,this.lhid).then(res => {\n                    console.log(res)\n\n                    if(res.data.rspCode == 1){\n                        console.log(res,'开始直播')\n                    }\n                })\n            },\n      \n            //声网结束直播\n            async leaveLive(){\n                if (this.localTracks.audioTrack) {\n                    this.localTracks.audioTrack.stop();\n                    this.localTracks.audioTrack.close();\n                    this.localTracks.audioTrack = undefined;\n                }\n\n                if (this.localTracks.videoTrack) {\n                    this.localTracks.videoTrack.stop();\n                    this.localTracks.videoTrack.close();\n                    this.localTracks.videoTrack = undefined;\n                }\n\n                await this.client.unpublish();\n                // leave the channel\n                await this.client.leave();\n            },\n            //初始化直播 分辨率   \n            initVideoProfiles() {\n                this.curVideoProfile = this.videoProfiles[3];\n            },\n            //活动星空结束直播\n            endSkyLive(){\n                this.leaveLive()\n                postSkyEndLive(this.eventId,this.lhid).then(res => {\n                    console.log(res)\n                    if(res.data.rspCode == 1){\n                        console.log(res,'结束直播')\n                    }\n                })\n            }\n        },\n        mounted(){\n           this.clientHeight = `${document.documentElement.clientHeight}`;\n           let that = this\n           window.onresize = function(){\n                that.clientHeight =  `${document.documentElement.clientHeight}`;\n                if(that.$refs.live){\n                    that.$refs.live.style.minHeight = that.clientHeight + 'px';\n                }\n            }\n        },\n        created(){\n            this.eventId = this.$route.params.pathMatch\n\n            var browerSupport = AgoraRTC.checkSystemRequirements();\n            if (browerSupport) {\n                this.client = AgoraRTC.createClient({ mode: \"live\", codec: \"h264\" });\n                //screenShareClient = AgoraRTC.createClient({ mode: \"live\", codec: \"vp8\" });\n            } else {\n                alert(\"The Brower is not support live!\");\n                return;\n            }\n            this.initVideoProfiles();\n        },\n        watch:{\n            clientHeight(clientHeight){\n               this.$refs.live.style.minHeight = clientHeight + 'px';\n            }\n        }\n    }\n</script>\n\n<style lang=\"less\" scoped>\n    .live{\n        padding: 120px 0 150px;\n        box-sizing: border-box;\n        background: #0F5F54;\n    }\n    .player-box{\n        width: 90%;\n        height: 600px;\n        margin: 0 auto;\n        position: relative;\n        .player-btn{\n            display: inline-block;\n            position: absolute;\n            margin: auto;\n            left: 50%;\n            transform: translate3d(-50%,-50%,0);\n            cursor: pointer;\n            top: 50%;\n            .video{\n                width: 115px;\n                margin:0 auto 40px;\n                display: block;\n            }\n            .text{\n                background: #027AFF;\n                border-radius: 6px;\n                border: 1px solid #979797;\n                color: #fff;\n                line-height: 42px;\n                display: inline-block;\n                padding: 0 30px;\n            }\n        }\n        .endBtn{\n            display: inline-block;\n            position: absolute;\n            left: 50%;\n            transform: translateX(-50%);\n            bottom: 18px;\n            padding: 0 30px;\n            color: #fff;\n            cursor: pointer;\n            line-height: 44px;\n            background: #FF5755;\n            border-radius: 6px;\n            border: 1px solid #979797;\n        }\n    }\n</style>"]}]}